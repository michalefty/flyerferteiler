<!DOCTYPE html>
<html>
<head>
    <title>Flyer-Planer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; margin-bottom: 20px; }
        .free { color: green; }
        .taken { color: red; text-decoration: line-through; }
        .sector-badge { background: #eee; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Planung: {{ metadata.city }}</h1>
    <p>Soll-Menge pro Person: {{ metadata.target_per_person }} Flyer</p>

    <div id="map"></div>

    <div id="controls">
        <h3>Straßenliste (Sektoren 1-{{ (metadata.total_households / metadata.target_per_person)|round|int }})</h3>
        <ul id="list">
            {% for id, s in streets.items() %}
            <li id="item-{{ id }}" class="{{ s.status }}">
                <span class="sector-badge">Sektor {{ s.sector }}</span>
                <strong>{{ s.name }}</strong> ({{ s.households }} Stk.)
                {% if s.status == 'free' %}
                <button onclick="selectStreet('{{ id }}')">Übernehmen</button>
                {% else %}
                - Belegt durch {{ s.user }}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([50.1, 9.1], 14); // Koordinaten aus Metadata nutzen
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var streets = {{ streets|tojson }};
        
        // Marker für jede Straße setzen
        Object.keys(streets).forEach(id => {
            var s = streets[id];
            var color = s.status === 'free' ? 'green' : 'red';
            var marker = L.circleMarker(s.coords, { color: color, radius: 8 }).addTo(map);
            
            marker.bindPopup(`<b>${s.name}</b><br>${s.households} Haushalte<br>
                             ${s.status === 'free' ? `<button onclick="selectStreet('${id}')">Reservieren</button>` : 'Belegt'}`);
        });

        function selectStreet(id) {
            const user = prompt("Dein Name:");
            if (user) {
                fetch('/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id, status: 'taken', user: user})
                }).then(() => location.reload());
            }
        }
    </script>
</body>
</html>