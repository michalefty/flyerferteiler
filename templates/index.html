<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyer-Planer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --free: #27ae60; --taken: #e74c3c; --primary: #2c3e50; --info: #3498db; --mine: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #f4f7f6; }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #map { height: 500px; width: 100%; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .street-list { background: white; padding: 15px; border-radius: 12px; max-height: 400px; overflow-y: auto; }
        .street-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
        .street-info { flex-grow: 1; }
        .badge { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-left: 5px; }
    </style>
</head>
<body>
    <h1>Flyer-Verteilung {{ metadata.city }}</h1>
    
    <div class="stats-bar">
        <div class="stat-card"><h4>Offen</h4><p id="s-open">-</p></div>
        <div class="stat-card"><h4>Vergeben</h4><p id="s-taken">-</p></div>
        <div class="stat-card"><h4>Meine Route</h4><p id="s-mine" style="color:var(--mine)">-</p></div>
        <div class="stat-card"><h4>Gesamt HÃ¤user</h4><p id="s-house" style="color:var(--info)">-</p></div>
    </div>

    <div class="controls">
        <button id="selectBtn" class="btn" style="background:var(--info)" onclick="toggleSelectionMode()">ğŸŸ¦ Bereich wÃ¤hlen</button>
        <button class="btn" style="background:var(--primary)" onclick="exportToPDF()">ğŸ“„ PDF Export (Meine)</button>
        <button class="btn" style="background:#95a5a6" onclick="resetName()">Name: <span id="currentName">...</span></button>
        <button class="btn" style="background:#34495e" onclick="toggleAdmin()">ğŸ”‘ Admin</button>
        <div id="adminControls" style="display:none; gap:10px;">
            <button class="btn" style="background:#e67e22" onclick="startDrawing()">âœï¸ StraÃŸe einzeichnen</button>
            <button id="finishDrawBtn" class="btn" style="background:#27ae60; display:none;" onclick="finishDrawing()">âœ… Fertig</button>
            <button class="btn" style="background:#8e44ad" onclick="downloadExport()">ğŸŒ Export GeoJSON</button>
        </div>
        <input type="text" id="searchBox" placeholder="StraÃŸensuche..." onkeyup="filterList()" style="padding:10px; border:1px solid #ccc; border-radius:6px; width: 200px;">
    </div>

    <div id="map"></div>

    <div class="street-list">
        <h3>Alle StraÃŸen</h3>
        <ul id="main-list" style="list-style:none; padding:0;">
            <!-- Wird per JS gefÃ¼llt -->
        </ul>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize with a default view to prevent errors before data load
        const map = L.map('map').setView([51.1657, 10.4515], 6); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const streets = {{ streets|tojson }};
        const layers = {}; // Stores both marker and polyline
        const markerGroup = [];
        let currentUser = localStorage.getItem('userName') || "";

        function init() {
            if (!currentUser) {
                currentUser = prompt("Bitte gib deinen Namen ein:");
                if (currentUser) localStorage.setItem('userName', currentUser);
            }
            document.getElementById('currentName').innerText = currentUser || "Nicht gesetzt";
            renderMap();
            renderList();
            updateStats();
        }

        function renderMap() {
            // Cleanup existing layers
            Object.values(layers).forEach(l => {
                if(l.marker) map.removeLayer(l.marker);
                if(l.line) map.removeLayer(l.line);
            });
            
            Object.keys(streets).forEach(id => {
                const s = streets[id];
                const isMine = s.user === currentUser && s.status === 'taken';
                const isFree = s.status === 'free';
                
                let color = isFree ? '#27ae60' : '#e74c3c';
                if (isMine) color = '#f39c12'; // Orange for mine

                // 1. Draw Polyline (if path exists)
                let lineLayer = null;
                if (s.path && s.path.length > 0) {
                    lineLayer = L.polyline(s.path, { color: color, weight: isMine ? 6 : 4, opacity: 0.7 }).addTo(map);
                    // Click on line -> Trigger Popup on Marker
                    lineLayer.on('click', () => marker.openPopup());
                }

                // 2. Draw Marker (Center)
                const marker = L.circleMarker(s.coords, { color: color, radius: isMine ? 8 : 5, fillOpacity: 0.9, weight: 1, fillColor: 'white' }).addTo(map);
                
                let btnHtml = "";
                if (isFree) {
                    btnHtml = `<button onclick="updateStatus('${id}', 'taken')" style="background:#27ae60; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">Ãœbernehmen</button>`;
                } else if (isMine) {
                    btnHtml = `<button onclick="updateStatus('${id}', 'free')" style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">Freigeben</button>`;
                } else {
                    btnHtml = `<span style="color:#e74c3c">Belegt: ${s.user}</span>`;
                }

                if(isAdmin) {
                    btnHtml += `<hr style="margin:5px 0"><div style="display:flex; gap:5px; justify-content:center;">
                        <button onclick="editStreet('${id}')" style="background:#f1c40f; border:none; border-radius:4px; cursor:pointer;">âœï¸</button>
                        <button onclick="deleteStreet('${id}')" style="background:#e74c3c; border:none; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸</button>
                    </div>`;
                }

                const popupContent = `
                    <div style="text-align:center;">
                        <b>${s.name}</b><br>
                        ğŸ  ${s.households} HÃ¤user | ğŸ“ ${s.length ? s.length + 'm' : '?'}<br><br>
                        ${btnHtml}
                    </div>
                `;
                marker.bindPopup(popupContent);
                if(lineLayer) lineLayer.bindPopup(popupContent);

                layers[id] = { marker: marker, line: lineLayer };
                markerGroup.push(L.latLng(s.coords[0], s.coords[1]));
            });

            // Restore view logic... (simplified for brevity)
            if(markerGroup.length > 0 && !localStorage.getItem('mapCenter')) 
                map.fitBounds(L.latLngBounds(markerGroup), {padding: [30,30]});
        }

        function filterList() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.street-item');
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        function renderList() {
            const list = document.getElementById('main-list');
            list.innerHTML = '';
            
            // Sort: Mine first, then Free, then Taken
            const sortedIds = Object.keys(streets).sort((a,b) => {
                const sA = streets[a], sB = streets[b];
                const wA = sA.user === currentUser ? 2 : (sA.status === 'free' ? 1 : 0);
                const wB = sB.user === currentUser ? 2 : (sB.status === 'free' ? 1 : 0);
                return wB - wA || sA.name.localeCompare(sB.name);
            });

            sortedIds.forEach(id => {
                const s = streets[id];
                const isMine = s.user === currentUser;
                const li = document.createElement('li');
                li.className = 'street-item';
                
                let actionBtn = '';
                if(s.status === 'free') {
                    actionBtn = `<button style="background:var(--free); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="updateStatus('${id}', 'taken')">Hol ich!</button>`;
                } else if(isMine) {
                    actionBtn = `<button style="background:var(--taken); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="updateStatus('${id}', 'free')">Freigeben</button>`;
                } else {
                    actionBtn = `<small style="color:var(--taken)">${s.user}</small>`;
                }

                if(isAdmin) {
                    actionBtn += ` <button onclick="editStreet('${id}')" style="background:none; border:none; cursor:pointer;">âœï¸</button>
                                   <button onclick="deleteStreet('${id}')" style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸</button>`;
                }

                li.innerHTML = `
                    <div class="street-info" style="${isMine ? 'font-weight:bold; color:var(--mine);' : ''}">
                        ${s.name} 
                        <span class="badge">ğŸ  ${s.households}</span>
                        <span class="badge">ğŸ“ ${s.length || 0}m</span>
                    </div>
                    <div>${actionBtn}</div>
                `;
                // Click on list item -> Zoom to map
                li.querySelector('.street-info').onclick = () => {
                    const l = layers[id];
                    if(l) {
                        map.flyTo(l.marker.getLatLng(), 17);
                        l.marker.openPopup();
                    }
                };
                li.querySelector('.street-info').style.cursor = 'pointer';
                
                list.appendChild(li);
            });
        }


        function updateStats() {
            let open = 0, taken = 0, mine = 0, houses = 0;
            Object.values(streets).forEach(s => {
                houses += s.households;
                if(s.status === 'free') open++;
                else {
                    taken++;
                    if(s.user === currentUser) mine++;
                }
            });
            document.getElementById('s-open').innerText = open;
            document.getElementById('s-taken').innerText = taken;
            document.getElementById('s-mine').innerText = mine;
            document.getElementById('s-house').innerText = houses;
        }

        function updateStatus(id, newStatus) {
            if(!currentUser) return init();
            
            const ids = Array.isArray(id) ? id : [id];
            
            // Optimistic update
            ids.forEach(sid => {
                streets[sid].status = newStatus;
                streets[sid].user = newStatus === 'free' ? '' : currentUser;
            });
            renderMap(); renderList(); updateStats(); // Local update

            // Server update
            localStorage.setItem('mapCenter', JSON.stringify(map.getCenter()));
            localStorage.setItem('mapZoom', map.getZoom());
            
            fetch('/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, status: newStatus, user: currentUser})
            }).then(() => {
                // Reload not strictly needed if optimistic worked, but good for sync
                // location.reload(); 
            });
        }

        // Selection Tool
        let isSelecting = false, rect = null, start = null;

        function toggleSelectionMode() {
            isSelecting = !isSelecting;
            document.getElementById('selectBtn').style.background = isSelecting ? 'orange' : 'var(--info)';
            
            // Disable map dragging and tap interactions when selecting
            if (isSelecting) {
                map.dragging.disable();
                if (map.tap) map.tap.disable();
                map.getContainer().style.cursor = 'crosshair';
            } else {
                map.dragging.enable();
                if (map.tap) map.tap.enable();
                map.getContainer().style.cursor = '';
            }
        }

        // Unified Start Handler
        function onDragStart(e) {
            if (!isSelecting) return;
            // Prevent default to stop scrolling on mobile
            L.DomEvent.preventDefault(e); 
            
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            start = latlng;
            rect = L.rectangle([start, start], {color: '#3498db', weight: 2}).addTo(map);
        }

        // Unified Move Handler
        function onDragMove(e) {
            if (isSelecting && rect) {
                L.DomEvent.preventDefault(e);
                const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
                rect.setBounds([start, latlng]);
            }
        }

        // Unified End Handler
        function onDragEnd(e) {
            if (!isSelecting || !rect) return;
            
            const b = rect.getBounds();
            const ids = Object.keys(streets).filter(id => streets[id].status === 'free' && b.contains(streets[id].coords));
            
            if (ids.length > 0) {
                if (confirm(`${ids.length} StraÃŸen reservieren?`)) updateStatus(ids, 'taken');
            }
            
            map.removeLayer(rect);
            rect = null;
            toggleSelectionMode(); // Exit selection mode automatically
        }

        // Add Listeners for Mouse and Touch
        map.on('mousedown', onDragStart);
        map.on('mousemove', onDragMove);
        map.on('mouseup', onDragEnd);

        // Map container listeners for touch (Leaflet sometimes swallows touch on the map object directly)
        const mapContainer = map.getContainer();
        
        mapContainer.addEventListener('touchstart', (e) => {
            if(!isSelecting) return;
            const touch = e.touches[0];
            // Create a fake Leaflet event object with latlng
            const point = map.containerPointToLatLng([touch.clientX - mapContainer.getBoundingClientRect().left, touch.clientY - mapContainer.getBoundingClientRect().top]);
            onDragStart({ latlng: point, originalEvent: e });
        }, {passive: false});

        mapContainer.addEventListener('touchmove', (e) => {
            if(!isSelecting) return;
            const touch = e.touches[0];
            const point = map.containerPointToLatLng([touch.clientX - mapContainer.getBoundingClientRect().left, touch.clientY - mapContainer.getBoundingClientRect().top]);
            onDragMove({ latlng: point, originalEvent: e });
        }, {passive: false});

        mapContainer.addEventListener('touchend', (e) => {
           onDragEnd(e);
        });

        // PDF Export
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(22);
            doc.text(`Flyer-Einsatzplan`, 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text(`Helfer: ${currentUser}`, 105, 30, { align: 'center' });
            doc.text(`Datum: ${new Date().toLocaleDateString()}`, 105, 38, { align: 'center' });

            const myStreets = Object.values(streets).filter(s => s.user === currentUser);
            
            if(myStreets.length === 0) { 
                alert("Du hast noch keine StraÃŸen gewÃ¤hlt!"); 
                return; 
            }

            // Stats
            const totalH = myStreets.reduce((sum, s) => sum + s.households, 0);
            const totalL = myStreets.reduce((sum, s) => sum + (s.length || 0), 0);
            
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            doc.setFontSize(12);
            doc.text(`Gesamt: ${myStreets.length} StraÃŸen | ${totalH} Haushalte | ca. ${Math.round(totalL/1000 * 10)/10} km`, 20, 55);

            let y = 70;
            doc.setFontSize(14);
            doc.text("Deine StraÃŸenliste:", 20, y);
            y += 10;
            
            // Table Header
            doc.setFillColor(230, 230, 230);
            doc.rect(20, y-6, 170, 8, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("StraÃŸe", 25, y);
            doc.text("HÃ¤user", 130, y);
            doc.text("LÃ¤nge", 160, y);
            doc.setFont(undefined, 'normal');
            y += 10;

            myStreets.sort((a,b) => a.name.localeCompare(b.name)).forEach((s, index) => {
                // Background for readability
                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(20, y-6, 170, 8, 'F');
                }
                
                // Checkbox
                doc.rect(22, y-4, 4, 4);
                
                // Content
                doc.text(s.name, 30, y);
                doc.text(`${s.households}`, 130, y);
                doc.text(`${s.length || 0}m`, 160, y);
                
                y += 8; 
                
                // New Page Logic
                if(y > 270) { 
                    doc.addPage(); 
                    y = 20; 
                    doc.setFontSize(10);
                    doc.text("(Fortsetzung)", 20, y);
                    y += 10;
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Seite ${i} von ${pageCount}`, 190, 285, { align: 'right' });
            }
            
            doc.save(`Flyer_Plan_${currentUser}.pdf`);
        }

        function resetName() { 
            const n = prompt("Neuer Name:"); 
            if(n) { 
                localStorage.setItem('userName', n); 
                currentUser = n; 
                document.getElementById('currentName').innerText = n;
                renderMap(); renderList(); // Refresh view
            } 
        }

        // --- Admin & Drawing Logic ---
        let isAdmin = false;
        let drawPoints = [];
        let drawLine = null;

        async function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('adminControls').style.display = 'none';
                renderMap(); renderList(); // Refresh to hide admin buttons
                return;
            }
            const pwd = prompt("Admin-Passwort:");
            if (!pwd) return;

            const res = await fetch('/admin/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pwd})
            });
            const data = await res.json();
            if (data.success) {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'flex';
                alert("Admin-Modus aktiv.");
                renderMap(); renderList(); // Refresh to show admin buttons
            } else {
                alert("Falsches Passwort!");
            }
        }

        function startDrawing() {
            if (!isAdmin) return;
            isSelecting = false; // Disable other modes
            map.dragging.disable();
            map.getContainer().style.cursor = 'crosshair';
            
            drawPoints = [];
            if (drawLine) map.removeLayer(drawLine);
            drawLine = L.polyline([], {color: 'red', weight: 4, dashArray: '5, 10'}).addTo(map);
            
            map.on('click', addDrawPoint);
            document.getElementById('finishDrawBtn').style.display = 'inline-block';
        }

        function addDrawPoint(e) {
            drawPoints.push([e.latlng.lat, e.latlng.lng]);
            drawLine.setLatLngs(drawPoints);
        }

        async function finishDrawing(force = false) {
            if (!force) {
                map.off('click', addDrawPoint);
                map.dragging.enable();
                map.getContainer().style.cursor = '';
                document.getElementById('finishDrawBtn').style.display = 'none';
            }

            if (drawPoints.length < 2) {
                alert("Bitte mindestens 2 Punkte setzen!");
                if(drawLine) map.removeLayer(drawLine);
                return;
            }

            let name, households;
            if (!force) {
                name = prompt("Name der StraÃŸe:");
                if (!name) return;
                
                // Auto-Count
                let defaultCount = "10";
                try {
                    const countRes = await fetch('/admin/count_houses', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({path: drawPoints})
                    });
                    const countData = await countRes.json();
                    if(countData.count) defaultCount = countData.count.toString();
                } catch(e) { console.error(e); }

                households = prompt("Anzahl Haushalte (Vorschlag basierend auf Karte):", defaultCount);
                if (!households) return;
            }

            // Calculate Length
            let length = 0;
            for(let i=0; i<drawPoints.length-1; i++) {
                length += map.distance(drawPoints[i], drawPoints[i+1]);
            }
            // Calculate Center
            const center = drawPoints[Math.floor(drawPoints.length/2)];

            const payload = {
                name: name, 
                households: parseInt(households),
                length: Math.round(length),
                coords: center,
                path: drawPoints,
                force: force
            };
            
            if(force) {
                 payload.name = window.lastDrawName;
                 payload.households = window.lastDrawHouseholds;
            } else {
                window.lastDrawName = name;
                window.lastDrawHouseholds = parseInt(households);
            }

            const res = await fetch('/admin/add_street', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            if (data.success) {
                alert("StraÃŸe gespeichert!");
                location.reload();
            } else if (data.error === 'duplicate') {
                if (confirm(`${data.msg}\nTrotzdem anlegen?`)) {
                    finishDrawing(true);
                }
            } else {
                alert("Fehler beim Speichern.");
            }
        }

        async function downloadExport() {
            window.open('/admin/export_geojson', '_blank');
        }

        async function editStreet(id) {
            const s = streets[id];
            const newName = prompt("Name Ã¤ndern:", s.name);
            if (newName === null) return;
            const newHouseholds = prompt("Haushalte Ã¤ndern:", s.households);
            if (newHouseholds === null) return;
            
            const res = await fetch('/admin/edit_street', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, name: newName, households: newHouseholds})
            });
            if((await res.json()).success) location.reload();
        }

        async function deleteStreet(id) {
            if(confirm(`StraÃŸe '${streets[id].name}' wirklich lÃ¶schen?`)) {
                const res = await fetch('/admin/delete_street', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                if((await res.json()).success) location.reload();
            }
        }

        init();
    </script>
</body>
</html>