<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyer-Planer</title>
    <link rel="stylesheet" href="/static/lib/leaflet/leaflet.css" />
    <script src="/static/lib/jspdf/jspdf.umd.min.js"></script>
    <script src="/static/lib/html2canvas/html2canvas.min.js"></script>
    <script src="/static/lib/leaflet-screenshoter/leaflet-simple-map-screenshoter.js"></script>
    <style>
        :root {
            --bg: #f4f7f6; --text: #000; --card-bg: white;
            --free: #27ae60; --taken: #e74c3c; --primary: #2c3e50; --info: #3498db; --mine: #f39c12;
            --btn-text-on-primary: white;
        }
        [data-theme="dark"] {
            --bg: #2c3e50; --text: #ecf0f1; --card-bg: #34495e;
            --primary: #ecf0f1; --info: #2980b9;
            --btn-text-on-primary: #2c3e50;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card-bg); padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #map { height: 500px; width: 100%; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        @media (max-width: 768px) {
            #map { width: 90%; margin-left: auto; margin-right: auto; }
        }
        /* Dark Mode Map Filter */
        [data-theme="dark"] .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .street-list { background: var(--card-bg); padding: 15px; border-radius: 12px; max-height: 400px; overflow-y: auto; }
        .street-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
        .street-info { flex-grow: 1; }
        .badge { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-left: 5px; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; color: var(--text); position: relative; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .footer-links { text-align: center; margin-top: 30px; font-size: 0.9em; opacity: 0.8; }
        .footer-links a { color: var(--info); margin: 0 10px; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    {% if is_preview %}
    <div style="background:#f1c40f; color:black; padding:15px; text-align:center; margin:-15px -15px 15px -15px; border-bottom:2px solid #d35400;">
        <h2 style="margin:0 0 5px 0;">‚ö†Ô∏è VORSCHAU MODUS (TEST) ‚ö†Ô∏è</h2>
        <span style="font-weight:normal; font-size:0.9em;">√Ñnderungen werden hier nicht dauerhaft gespeichert.</span><br>
        <button onclick="publishLive('{{ preview_uuid }}')" style="margin-top:10px; background:#c0392b; color:white; border:none; padding:10px 20px; font-size:1.1em; cursor:pointer; border-radius:6px; font-weight:bold;">üöÄ JETZT LIVE SCHALTEN</button>
    </div>
    {% endif %}
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Flyer-Ferteilung {{ metadata.city }}</h1>
        <div style="text-align:right">
            <small>Geplante Laufzeit: {{ survey_days }} Tage</small><br>
            <span id="countdown" style="font-weight:bold; color:var(--taken)"></span>
        </div>
    </div>
    
    <div class="stats-bar">
        <div class="stat-card"><h4><span style="color:var(--free)">‚ñ†</span> Offen</h4><p id="s-open">- Str.</p></div>
        <div class="stat-card"><h4><span style="color:var(--taken)">‚ñ†</span> Vergeben</h4><p id="s-taken">- Str.</p></div>
        <div class="stat-card"><h4><span style="color:var(--mine)">‚ñ†</span> Ausgew√§hlt</h4><p id="s-mine" style="color:var(--mine)">- Str.</p></div>
        <div class="stat-card"><h4>üè† H√§user (ca)</h4><p id="s-house" style="color:var(--info)">-</p></div>
    </div>
    <p style="text-align:center; font-size:0.85em; color:#7f8c8d; margin-top:-10px; margin-bottom: 20px;">
        ‚ÑπÔ∏è Hinweis: Es m√ºssen ggf. mehr, bei z.B. Mehrparteienh√§usern, oder weniger, wegen "Keine Werbung"-Aufklebern, Flyer ausgeteilt werden.
    </p>

    <div class="controls">
        <button id="selectBtn" class="btn" style="background:var(--info)" onclick="toggleSelectionMode()">üü¶ Bereich w√§hlen</button>
        <button class="btn" style="background:var(--primary); color:var(--btn-text-on-primary)" onclick="exportToPDF()">üìÑ PDF Export (Meine)</button>
        <button class="btn" style="background:#95a5a6" onclick="resetName()">Name: <span id="currentName">...</span></button>
        <button class="btn" style="background:#7f8c8d" onclick="openModal('helpModal')">‚ùì Hilfe</button>
        <button class="btn" style="background:#000" onclick="toggleTheme()">üåô Theme</button>
        
        <!-- Admin Toggle -->
        <button class="btn" style="background:transparent; color:var(--text); border:1px solid #ccc; font-weight:normal;" onclick="toggleAdmin()">üîí</button>

        <div id="adminControls" style="display:none; gap:10px; align-items:center;">
            <span id="adminStats" style="background:var(--card-bg); padding:8px; border-radius:4px; border:1px solid #ccc; font-size:0.9em;"></span>
            <button class="btn" style="background:#e67e22" onclick="startDrawing()">‚úèÔ∏è Stra√üe einzeichnen</button>
            <button id="finishDrawBtn" class="btn" style="background:#27ae60; display:none;" onclick="finishDrawing()">‚úÖ Fertig</button>
            <button class="btn" style="background:#8e44ad" onclick="downloadExport()">üåç Export GeoJSON</button>
        </div>
        <div id="selectionInfo" style="display:none; background:var(--info); color:white; padding:10px; border-radius:6px;"></div>
        <input type="text" id="searchBox" placeholder="Stra√üensuche..." onkeyup="filterList()" style="padding:10px; border:1px solid #ccc; border-radius:6px; width: 150px;">
    </div>

    <div style="margin-bottom:15px; padding:10px; border:1px solid #e74c3c; border-left: 5px solid #e74c3c; background-color: rgba(231, 76, 60, 0.1); color:var(--text); border-radius: 4px;">
        <strong style="color:#c0392b;">‚ö†Ô∏è Datenschutz-Hinweis (DSGVO):</strong><br>
        Bitte verwende zu deiner eigenen Sicherheit und Datensparsamkeit <b>nur deinen Spitznamen oder ein K√ºrzel</b> (z.B. "Lefty" oder "ML")!<br>
        Verzichte auf die Eingabe deines vollst√§ndigen Namens.
    </div>

    <div style="position:relative;">
        <div id="map"></div>
        <div id="map-lock" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.05); z-index:1000; align-items:center; justify-content:center; cursor:pointer; border-radius:12px;" onclick="enableMapInteraction()">
            <button style="background:var(--primary); color:var(--btn-text-on-primary); padding:10px 20px; border:none; border-radius:30px; font-size:1.1em; box-shadow:0 4px 15px rgba(0,0,0,0.3); pointer-events:none;">üëÜ Karte aktivieren</button>
        </div>
    </div>

    <div class="street-list">
        <h3>Alle Stra√üen</h3>
        <ul id="main-list" style="list-style:none; padding:0;">
            <!-- Wird per JS gef√ºllt -->
        </ul>
    </div>

    <div class="footer-links">
        <a onclick="openModal('impressumModal')">Impressum</a> | 
        <a onclick="openModal('privacyModal')">Datenschutz & Lizenz</a> |
        <a href="https://github.com/michalefty/flyerferteiler" target="_blank">GitHub</a>
    </div>
    
    <!-- Footer Quotes -->
    <div id="footer-egg" style="text-align:center; font-size:0.9em; color:#95a5a6; margin-top:15px; font-style:italic;"></div>

    <!-- Modals -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('helpModal')">&times;</span>
            <h2>üìñ Anleitung</h2>
            <ol>
                <li>Gib oben deinen <b>Namen (oder K√ºrzel)</b> an.</li>
                <li>W√§hle Stra√üen aus, die du √ºbernehmen m√∂chtest:
                    <ul>
                        <li>Klicke auf eine Stra√üe in der Karte oder Liste.</li>
                        <li>Nutze "Bereich w√§hlen", um einen Rahmen zu ziehen.</li>
                    </ul>
                </li>
                <li>Klicke auf <b>"√úbernehmen"</b> (gr√ºner Button).</li>
                <li>Wenn du fertig bist, klicke auf <b>"PDF Export"</b>, um deine Liste zu drucken.</li>
            </ol>
            <p>Viel Erfolg beim Verteilen! üèÉüí®</p>
        </div>
    </div>

    <div id="impressumModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('impressumModal')">&times;</span>
            <h2>Impressum</h2>
            <p><b>Angaben gem√§√ü ¬ß 5 TMG</b></p>
            <p>Michael Linke (Projektverantwortlicher)<br>
            Friedhofstr 16<br>
            63834 Sulzbach am Main</p>
            <p>Kontakt: flyerferteiler@ipct.net</p>
            <p><i>Dies ist ein Open-Source-Community-Projekt.</i></p>
        </div>
    </div>

    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('privacyModal')">&times;</span>
            <h2>Datenschutz & Lizenz</h2>
            <h3>Datenschutz</h3>
            <p>Bitte trage zu deiner eigenen Sicherheit nur deinen <b>Vornamen oder ein K√ºrzel</b> ein.</p>
            <p>Deine Daten (Name und gew√§hlte Stra√üen) werden auf unserem Server gespeichert, damit andere sehen k√∂nnen, welche Gebiete bereits abgedeckt sind.</p>
            <p>Die Daten werden nach Abschluss der Aktion (ca. {{ survey_days }} Tage) <b>automatisch gel√∂scht</b>.</p>
            <p>Wir verwenden LocalStorage in deinem Browser, um deinen Namen f√ºr deinen n√§chsten Besuch zu speichern.</p>
            <p><b>Technische Hinweise:</b><br>
            Alle verwendeten Programm-Bibliotheken (Karten-Darstellung, PDF-Erstellung) werden <b>lokal von unserem Server geladen</b>. Es finden keine Verbindungen zu Drittanbietern (CDNs) statt, um deine Privatsph√§re zu sch√ºtzen.</p>
            
            <h3>Lizenz & Credits</h3>
            <p><b>Software:</b> Dieses Projekt ist Open Source (MIT License).</p>
            <p><b>Kartendaten:</b> ¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende (ODbL).</p>
            <p><b>Verwendete Bibliotheken:</b></p>
            <ul style="font-size:0.9em;">
                <li><a href="https://leafletjs.com/" target="_blank">Leaflet</a> (BSD-2-Clause) - Interaktive Karte</li>
                <li><a href="https://parall.ax/products/jspdf" target="_blank">jsPDF</a> (MIT) - PDF Generierung</li>
                <li><a href="https://html2canvas.hertzen.com/" target="_blank">html2canvas</a> (MIT) - Screenshot Erstellung</li>
            </ul>
        </div>
    </div>

    <script src="/static/lib/leaflet/leaflet.js"></script>
    <script>
        // Initialize map (view will be updated in init)
        const map = L.map('map').setView([51.1657, 10.4515], 6); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Screenshoter Plugin
        const screenshoter = L.simpleMapScreenshoter({
            hidden: true,
            mimeType: 'image/jpeg'
        }).addTo(map);

        function enableMapInteraction() {
            map.dragging.enable();
            if (map.tap) map.tap.enable();
            map.scrollWheelZoom.enable();
            document.getElementById('map-lock').style.display = 'none';
        }

        // Mobile Scroll Protection
        if (L.Browser.mobile) {
            map.dragging.disable();
            if (map.tap) map.tap.disable();
            map.scrollWheelZoom.disable();
            // Wait for DOM to be ready implicitly or just set it
            // We need to ensure the element exists (it does, defined above)
            setTimeout(() => {
                 const lock = document.getElementById('map-lock');
                 if(lock) lock.style.display = 'flex';
            }, 100);
        }

        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.background = 'var(--card-bg)';
            div.style.padding = '10px';
            div.style.borderRadius = '8px';
            div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
            div.style.color = 'var(--text)';
            div.innerHTML = `
                <div style="margin-bottom:5px"><b>Legende</b></div>
                <div><span style="color:var(--free)">‚ñ†</span> Offen</div>
                <div><span style="color:var(--taken)">‚ñ†</span> Vergeben</div>
                <div><span style="color:var(--mine)">‚ñ†</span> Meine</div>
            `;
            return div;
        };
        legend.addTo(map);
        
        const streets = {{ streets|tojson }};
        const startDateStr = "{{ metadata.date }}";
        const durationDays = {{ survey_days }};
        const layers = {}; // Stores both marker and polyline
        const markerGroup = [];
        let currentUser = localStorage.getItem('userName') || "";
        let sortTargetId = null;

        function showRandomQuote() {
            const quotes = [
                "Wer schreibt, der bleibt - wer verteilt, der eilt!",
                "Schritte z√§hlen leicht gemacht.",
                "Frische Luft inklusive.",
                "Flyer verteilen: Das analoge Social Media.",
                "Heute schon gelaufen?",
                "Jeder Flyer z√§hlt!",
                "Verteilen ist wie Wandern, nur mit Mission.",
                "Der Weg ist das Ziel (und der Briefkasten).",
                "Flyerferteiler: Weil wir Flyer so flink fertig ferteilen.",
                "Das 'f' steht f√ºr fantastisch. Oder f√ºr 3 Uhr morgens ohne Kaffee.",
                "Flyerferteiler: Die einzige App, die schneller z√§hlt als du laufen kannst.",
                "Warum mit 'f'? Weil wir keine Konkurrenz haben, die es uns verbieten k√∂nnte.",
                "Vom Algorithmus berechnet, von strammen Waden ausgetragen.",
                "Flyerferteiler: Wir kennen jede Sackgasse. Buchst√§blich.",
                "Wir schreiben Verteilung mit 'f', weil wir Individualisten sind.",
                "Statistik: 10% Planung, 90% Treppensteigen, 100% Flyerferteiler.",
                "Wer Rechtschreibfehler findet, darf sie behalten. Wer Briefk√§sten findet, darf einwerfen.",
                "Flyerferteiler: Damit du nicht dreimal in die gleiche Sackgasse l√§ufst.",
                "Unsere Karte ist pr√§ziser als dein Orientierungssinn nach dem zehnten Wohnblock.",
                "Wir haben das 'f' im Namen und den Turbo in den Beinen.",
                "Flyerferteiler: Fehlerfrei bei der Hausnummer, kreativ bei der Rechtschreibung.",
                "Keine Konkurrenz, keine Kompromisse, kein 'v'."
            ];
            const q = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('footer-egg').innerText = q;
        }

        function getDist(s1, s2) {
            if (s1 === s2) return 0;
            return map.distance(s1.coords, s2.coords);
        }

        // Calculate neighbors based on geometry (point-to-point)
        function getNeighbors(id) {
            const s1 = streets[id];
            const neighbors = [];
            if (!s1.path) return [];
            
            // Flatten to get all points: [[[lat,lon]...]] -> [[lat,lon]...]
            const p1Points = s1.path.flat(); 

            Object.keys(streets).forEach(oid => {
                if (id === oid) return;
                const s2 = streets[oid];
                if (!s2.path) return;
                
                // Fast Center Check (skip if > 500m)
                if (map.distance(s1.coords, s2.coords) > 500) return;

                let minD = Infinity;
                const p2Points = s2.path.flat();
                
                // Check distance between points
                // Optimization: Check only first/last points of segments for connectivity? 
                // Full check is safer for T-junctions.
                for (let p1 of p1Points) {
                    for (let p2 of p2Points) {
                        const d = map.distance(p1, p2);
                        if(d < minD) minD = d;
                        if(minD < 10) break; // Connected
                    }
                    if(minD < 10) break;
                }
                
                if (minD < 40) { // Consider neighbors if < 40m
                     neighbors.push({id: oid, ...s2, dist: minD});
                }
            });
            return neighbors.sort((a,b) => a.dist - b.dist);
        }

        function sortByProximity(id) {
            sortTargetId = id;
            renderList();
            updateHighlights();
            // Scroll to top of list
            document.querySelector('.street-list').scrollTop = 0;
        }

        function resetSort() {
            sortTargetId = null;
            renderList();
            updateHighlights();
        }

        function generatePopupContent(id) {
            const s = streets[id];
            const isMine = s.user === currentUser && s.status === 'taken';
            const isFree = s.status === 'free';
            
            let color = isFree ? '#27ae60' : '#e74c3c';
            if (isMine) color = '#f39c12'; 
            else if (!isFree && s.user) color = getUserColor(s.user);

            let btnHtml = "";
            if (isFree) {
                btnHtml = `<button onclick="updateStatus('${id}', 'taken')" style="background:#27ae60; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; width:100%; margin-top:5px;">√úbernehmen</button>`;
            } else if (isMine) {
                btnHtml = `<button onclick="updateStatus('${id}', 'free')" style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; width:100%; margin-top:5px;">Freigeben</button>`;
            } else {
                btnHtml = `<div style="display:flex;align-items:center;justify-content:center;gap:5px; margin-top:5px;">
                    <span style="color:${color}; font-weight:bold;">Belegt: ${s.user}</span>
                    <button onclick="stealStreet('${id}')" title="√úbernehmen" style="background:white; border:1px solid #ccc; border-radius:4px; cursor:pointer;">‚úã</button>
                </div>`;
            }

            if(isAdmin) {
                btnHtml += `<hr style="margin:5px 0"><div style="display:flex; gap:5px; justify-content:center;">
                    <button onclick="editStreet('${id}')" style="background:#f1c40f; border:none; border-radius:4px; cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="deleteStreet('${id}')" style="background:#e74c3c; border:none; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
                </div>`;
            }

            // Neighbors
            const neighbors = getNeighbors(id);
            let neighborHtml = "";
            if(neighbors.length > 0) {
                neighborHtml = '<div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px; font-size:0.9em;"><strong>Angrenzend:</strong><div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-top:5px;">';
                neighbors.slice(0, 5).forEach(n => {
                     const nIsFree = n.status === 'free';
                     const nIsMine = n.user === currentUser;
                     const bg = nIsFree ? '#27ae60' : (nIsMine ? '#f39c12' : '#e74c3c');
                     
                     // Helper: Escape single quotes for JS string
                     const safeName = n.name.replace(/'/g, "\'");
                     const onClick = nIsFree ? `updateStatus('${n.id}', 'taken')` : `map.flyTo([${n.coords}], 18); map._layers[layers['${n.id}'].marker._leaflet_id].openPopup();`; // Direct popup open approach for taken
                     
                     neighborHtml += `<button onclick="${onClick}" style="background:${bg}; color:white; border:none; padding:4px 8px; border-radius:12px; font-size:0.85em; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,0.1);" title="${nIsFree ? '√úbernehmen' : 'Zeigen'}">${n.name}</button>`;
                });
                neighborHtml += '</div></div>';
            }

            return `
                <div style="text-align:center; min-width:220px;">
                    <b style="font-size:1.15em">${s.name}</b><br>
                    <span style="color:#7f8c8d; font-size:0.9em;">üè† ${s.households} H√§user | üìè ${s.length ? s.length + 'm' : '?'}</span>
                    ${btnHtml}
                    ${neighborHtml}
                </div>
            `;
        }

        function init() {
            if (!currentUser) {
                currentUser = prompt("Willkommen! Bitte gib deinen Vornamen oder ein K√ºrzel ein:");
                if (currentUser) localStorage.setItem('userName', currentUser);
            }
            document.getElementById('currentName').innerText = currentUser || "Nicht gesetzt";
            
            // Initial View Strategy: Prefer BBox from backend
            const bbox = {{ metadata.bbox|tojson if metadata.bbox else 'null' }};
            
            if (bbox) {
                 map.fitBounds(bbox, {padding: [50,50]});
            } else if (localStorage.getItem('mapCenter')) {
                map.setView(JSON.parse(localStorage.getItem('mapCenter')), localStorage.getItem('mapZoom'));
            } else {
                // Fallback: Calculate bounds client-side
                Object.values(streets).forEach(s => markerGroup.push(s.coords));
                if (markerGroup.length > 0) map.fitBounds(markerGroup, {padding: [50,50]});
                else map.setView({{ metadata.center|tojson }}, 14);
            }

            renderMap();
            renderList();
            updateStats();
            updateCountdown();
            showRandomQuote();
            
            if (!localStorage.getItem('helpSeen')) {
                openModal('helpModal');
                localStorage.setItem('helpSeen', 'true');
            }
        }

        // Modal Logic
        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
        }

        function updateCountdown() {
             if(!startDateStr) return;
             const parts = startDateStr.split('.');
             if(parts.length !== 3) return;
             
                      const start = new Date(parts[2], parts[1]-1, parts[0]); 
                      const end = new Date(start);
                      end.setDate(end.getDate() + durationDays);
                      end.setHours(23, 59, 59, 999);
                      
                      const now = new Date();             const diff = end - now;
             
             const el = document.getElementById('countdown');
             if (diff < 0) {
                 el.innerText = "Beendet";
                 return;
             }
             
             const days = Math.floor(diff / (1000 * 60 * 60 * 24));
             const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
             
             el.innerText = `‚è≥ Noch ${days}d ${hours}h`;
        }

        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            // Avoid green spectrum (approx 80-170) to distinguish from "free" (green)
            let hue = Math.abs(hash % 360);
            if (hue > 70 && hue < 180) {
                 hue = (hue + 110) % 360; 
            }
            return `hsl(${hue}, 65%, 40%)`; 
        }

        const highlightGroup = L.layerGroup().addTo(map);

        function renderMap() {
            Object.keys(streets).forEach(id => {
                const s = streets[id];
                const isMine = s.user === currentUser && s.status === 'taken';
                const isFree = s.status === 'free';
                
                let color = isFree ? '#27ae60' : '#e74c3c';
                if (isMine) color = '#f39c12'; 
                else if (!isFree && s.user) color = getUserColor(s.user);

                const lineStyle = { color: color, weight: isMine ? 6 : 4, opacity: 0.8 };
                const markerStyle = { color: color, radius: isMine ? 8 : 5, fillOpacity: 0.9, weight: 1, fillColor: 'white' };

                if (layers[id]) {
                    // Update existing
                    if(layers[id].line) layers[id].line.setStyle(lineStyle);
                    if(layers[id].marker) layers[id].marker.setStyle(markerStyle);
                } else {
                    // Create new
                    let lineLayer = null;
                    if (s.path && s.path.length > 0) {
                        lineLayer = L.polyline(s.path, lineStyle).addTo(map);
                        lineLayer.streetId = id;
                        lineLayer.bindPopup(() => generatePopupContent(id));
                    }

                    const marker = L.circleMarker(s.coords, markerStyle).addTo(map);
                    marker.streetId = id;
                    marker.bindPopup(() => generatePopupContent(id));

                    layers[id] = { marker: marker, line: lineLayer };
                }
            });
            updateHighlights();
        }

        function updateHighlights() {
            highlightGroup.clearLayers();
            if (!sortTargetId) return;

            Object.keys(streets).forEach(id => {
                const s = streets[id];
                if (!s.path || s.path.length === 0) return;

                if (id === sortTargetId) {
                    // Highlight Target (thick transparent overlay)
                    L.polyline(s.path, { color: '#3498db', weight: 12, opacity: 0.3 }).addTo(highlightGroup);
                } else {
                    // Highlight Neighbors
                    const dist = map.distance(s.coords, streets[sortTargetId].coords);
                    if (dist < 800) {
                         // Simple distance check for visual noise reduction
                         // The dashed line overlay
                         L.polyline(s.path, { color: '#3498db', weight: 2, dashArray: '5, 10', opacity: 0.6, interactive: false }).addTo(highlightGroup);
                    }
                }
            });
        }

        // Global Event Listener for Popup Open (to sort list)
        map.on('popupopen', function(e) {
            const layer = e.popup._source;
            if (layer && layer.streetId) {
                // Don't call renderMap, just sort list and highlights
                sortByProximity(layer.streetId); 
            }
        });

        function filterList() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.street-item');
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        function renderList() {
            const list = document.getElementById('main-list');
            list.innerHTML = '';
            
            const sortedIds = Object.keys(streets).sort((a,b) => {
                const sA = streets[a], sB = streets[b];
                const wA = sA.user === currentUser ? 2 : (sA.status === 'free' ? 1 : 0);
                const wB = sB.user === currentUser ? 2 : (sB.status === 'free' ? 1 : 0);
                
                if (wA !== wB) return wB - wA;
                if (sortTargetId) return getDist(sA, streets[sortTargetId]) - getDist(sB, streets[sortTargetId]);
                return sA.name.localeCompare(sB.name);
            });

            const h3 = document.querySelector('.street-list h3');
            if(h3) {
                if (sortTargetId) h3.innerHTML = `Nahe '${streets[sortTargetId].name}' <button onclick="resetSort()" style="border:none;background:none;cursor:pointer">‚ùå</button>`;
                else h3.innerText = "Alle Stra√üen";
            }

            sortedIds.forEach(id => {
                const s = streets[id];
                const isMine = s.user === currentUser;
                const li = document.createElement('li');
                li.className = 'street-item';
                
                let actionBtn = '';
                if(s.status === 'free') {
                    actionBtn = `<button style="background:var(--free); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="updateStatus('${id}', 'taken')">Mach' ich!</button>`;
                } else if(isMine) {
                    actionBtn = `<button style="background:var(--taken); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="updateStatus('${id}', 'free')">Freigeben</button>`;
                } else {
                    actionBtn = `<small style="color:var(--taken)">${s.user}</small> <button onclick="stealStreet('${id}')" style="border:1px solid #ccc; background:none; cursor:pointer; font-size:0.8em">‚úã</button>`;
                }

                if(isAdmin) {
                    actionBtn += ` <button onclick="editStreet('${id}')" style="background:none; border:none; cursor:pointer;">‚úèÔ∏è</button>
                                   <button onclick="deleteStreet('${id}')" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button>`;
                }

                li.innerHTML = `
                    <div class="street-info" style="${isMine ? 'font-weight:bold; color:var(--mine);' : ''}">
                        ${s.name} 
                        <span class="badge">üè† ${s.households}</span>
                        <span class="badge">üìè ${s.length || 0}m</span>
                    </div>
                    <div>${actionBtn}</div>
                `;
                
                li.querySelector('.street-info').onclick = () => {
                    const l = layers[id];
                    if(l) {
                        map.flyTo(l.marker.getLatLng(), 17);
                        l.marker.openPopup();
                    }
                };
                li.querySelector('.street-info').style.cursor = 'pointer';
                list.appendChild(li);
            });
        }
        
        function stealStreet(id) {
             const s = streets[id];
             if(confirm(`M√∂chtest du die Stra√üe '${s.name}' von ${s.user} √ºbernehmen?
(Bitte nur nach Absprache!)`)) {
                 updateStatus(id, 'taken'); 
             }
        }

        function updateStats() {
            let open = 0, taken = 0, mine = 0, totalHouses = 0, myHouses = 0;
            Object.values(streets).forEach(s => {
                totalHouses += s.households;
                if(s.status === 'free') open++;
                else {
                    taken++;
                    if(s.user === currentUser) {
                        mine++;
                        myHouses += s.households;
                    }
                }
            });
            document.getElementById('s-open').innerText = open + " Str.";
            document.getElementById('s-taken').innerText = taken + " Str.";
            document.getElementById('s-mine').innerText = mine + " Str.";
            document.getElementById('s-house').innerText = `${myHouses} / ${totalHouses}`;
        }

        function updateStatus(id, newStatus) {
            if(!currentUser) return init();
            
            const ids = Array.isArray(id) ? id : [id];
            
            ids.forEach(sid => {
                streets[sid].status = newStatus;
                streets[sid].user = newStatus === 'free' ? '' : currentUser;
            });
            
            // --- REFRESH POPUP CONTENT ---
            // If popup is open, update it so chips change color instantly
            const popup = map._popup; 
            if (popup && popup._source && popup.isOpen()) {
                const sourceId = popup._source.streetId;
                popup.setContent(generatePopupContent(sourceId));
            }

            renderMap(); 
            renderList(); 
            updateStats(); 
            // Do not call updateHighlights directly, it's called by renderMap or sortByProximity
            // But we need to ensure highlights update if status changed colors? 
            // renderMap calls updateHighlights at the end.

            localStorage.setItem('mapCenter', JSON.stringify(map.getCenter()));
            localStorage.setItem('mapZoom', map.getZoom());
            
            fetch('/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, status: newStatus, user: currentUser})
            });
        }

        // Selection Tool
        let isSelecting = false, rect = null, start = null;

        function toggleSelectionMode() {
            isSelecting = !isSelecting;
            document.getElementById('selectBtn').style.background = isSelecting ? 'orange' : 'var(--info)';
            document.getElementById('selectionInfo').style.display = 'none';
            if (isSelecting) {
                map.dragging.disable();
                if (map.tap) map.tap.disable();
                map.getContainer().style.cursor = 'crosshair';
            } else {
                map.dragging.enable();
                if (map.tap) map.tap.enable();
                map.getContainer().style.cursor = '';
            }
        }

        function onDragStart(e) {
            if (!isSelecting) return;
            L.DomEvent.preventDefault(e); 
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            start = latlng;
            rect = L.rectangle([start, start], {color: '#3498db', weight: 2}).addTo(map);
        }

        function onDragMove(e) {
            if (isSelecting && rect) {
                L.DomEvent.preventDefault(e);
                const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
                rect.setBounds([start, latlng]);
                
                // Update Selection Info
                const b = rect.getBounds();
                let count = 0, houses = 0, length = 0;
                Object.values(streets).forEach(s => {
                    if (s.status === 'free' && b.contains(s.coords)) {
                        count++;
                        houses += s.households;
                        length += (s.length || 0);
                    }
                });
                const info = document.getElementById('selectionInfo');
                if (count > 0) {
                    info.style.display = 'inline-block';
                    info.innerHTML = `Auswahl: <b>${count}</b> Stra√üen | üè† ${houses} | üìè ${(length/1000).toFixed(1)}km`;
                } else {
                    info.style.display = 'none';
                }
            }
        }

        function onDragEnd(e) {
            if (!isSelecting || !rect) return;
            const b = rect.getBounds();
            const ids = Object.keys(streets).filter(id => streets[id].status === 'free' && b.contains(streets[id].coords));
            if (ids.length > 0) {
                if (confirm(`${ids.length} Stra√üen reservieren?`)) updateStatus(ids, 'taken');
            }
            map.removeLayer(rect);
            rect = null;
            toggleSelectionMode(); 
        }

        map.on('mousedown', onDragStart);
        map.on('mousemove', onDragMove);
        map.on('mouseup', onDragEnd);

        const mapContainer = map.getContainer();
        mapContainer.addEventListener('touchstart', (e) => {
            if(!isSelecting) return;
            const touch = e.touches[0];
            const point = map.containerPointToLatLng([touch.clientX - mapContainer.getBoundingClientRect().left, touch.clientY - mapContainer.getBoundingClientRect().top]);
            onDragStart({ latlng: point, originalEvent: e });
        }, {passive: false});

        mapContainer.addEventListener('touchmove', (e) => {
            if(!isSelecting) return;
            const touch = e.touches[0];
            const point = map.containerPointToLatLng([touch.clientX - mapContainer.getBoundingClientRect().left, touch.clientY - mapContainer.getBoundingClientRect().top]);
            onDragMove({ latlng: point, originalEvent: e });
        }, {passive: false});

        mapContainer.addEventListener('touchend', (e) => { onDragEnd(e); });

        // PDF Export
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(22);
            doc.text(`Flyer-Einsatzplan`, 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text(`Helfer: ${currentUser}`, 105, 30, { align: 'center' });
            doc.text(`Datum: ${new Date().toLocaleDateString()}`, 105, 38, { align: 'center' });

            const myStreets = Object.values(streets).filter(s => s.user === currentUser);
            
            if(myStreets.length === 0) { 
                alert("Du hast noch keine Stra√üen gew√§hlt!"); 
                return; 
            }

            const totalH = myStreets.reduce((sum, s) => sum + s.households, 0);
            const totalL = myStreets.reduce((sum, s) => sum + (s.length || 0), 0);
            
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            doc.setFontSize(12);
            doc.text(`Gesamt: ${myStreets.length} Stra√üen | ${totalH} Haushalte | ca. ${Math.round(totalL/1000 * 10)/10} km`, 20, 55);

            // Save current view
            const originalCenter = map.getCenter();
            const originalZoom = map.getZoom();

            // Zoom to bounds of selected streets
            const bounds = L.latLngBounds([]);
            let hasBounds = false;
            
            myStreets.forEach(s => {
                if (s.path) {
                    s.path.forEach(segment => {
                        segment.forEach(p => { bounds.extend(p); hasBounds = true; });
                    });
                } else if (s.coords) {
                    bounds.extend(s.coords);
                    hasBounds = true;
                }
            });

            if (hasBounds) {
                map.fitBounds(bounds, { padding: [50, 50] });
                // Wait for zoom and tiles to load
                await new Promise(resolve => setTimeout(resolve, 800));
            }

            // Capture Map
            try {
                // Use leaflet-simple-map-screenshoter
                const canvas = await screenshoter.takeScreen('canvas');
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                doc.addImage(imgData, 'JPEG', 20, 65, 170, 90); 
            } catch(e) {
                console.error(e);
                doc.text("(Kartenfehler)", 105, 110, {align:'center'});
            } finally {
                // Restore view
                map.setView(originalCenter, originalZoom);
            }

            let y = 165;
            doc.setFontSize(14);
            doc.text("Deine Stra√üenliste:", 20, y);
            y += 10;
            
            doc.setFillColor(230, 230, 230);
            doc.rect(20, y-6, 170, 8, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("Stra√üe", 25, y);
            doc.text("H√§user", 130, y);
            doc.text("L√§nge", 160, y);
            doc.setFont(undefined, 'normal');
            y += 10;

            myStreets.sort((a,b) => a.name.localeCompare(b.name)).forEach((s, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(20, y-6, 170, 8, 'F');
                }
                doc.rect(22, y-4, 4, 4);
                doc.text(s.name, 30, y);
                doc.text(`${s.households}`, 130, y);
                doc.text(`${s.length || 0}m`, 160, y);
                y += 8; 
                if(y > 270) { 
                    doc.addPage(); y = 20; 
                    doc.text("(Fortsetzung)", 20, y); y += 10;
                }
            });
            doc.save(`Flyer_Plan_${currentUser}.pdf`);
        }

        function resetName() { 
            const n = prompt("Neuer Name (Vorname/K√ºrzel):"); 
            if(n) { 
                if (n.toLowerCase() === 'ferteiler') {
                    alert("üê∞ Easter Egg gefunden!\n\nWarum 'Ferteiler'?\nWeil wir Flyer so schnell verteilen, dass f√ºr Rechtschreibung keine Zeit blieb! üèÉüí®");
                }
                localStorage.setItem('userName', n); 
                currentUser = n; 
                document.getElementById('currentName').innerText = n;
                renderMap(); renderList(); 
            } 
        }

        // --- Admin & Drawing Logic ---
        let isAdmin = false;
        let drawPoints = [];
        let drawLine = null;

        async function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('adminControls').style.display = 'none';
                renderMap(); renderList(); 
                return;
            }
            const pwd = prompt("Admin-Passwort:");
            if (!pwd) return;

            const res = await fetch('/admin/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pwd})
            });
            const data = await res.json();
            if (data.success) {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'flex';
                updateAdminStats();
                alert("Admin-Modus aktiv.");
                renderMap(); renderList(); 
            } else {
                alert("Falsches Passwort!");
            }
        }

        function updateAdminStats() {
            const users = new Set();
            Object.values(streets).forEach(s => {
                if(s.user) users.add(s.user);
            });
            document.getElementById('adminStats').innerText = `üë• ${users.size} Helfer`;
        }

        function startDrawing() {
            if (!isAdmin) return;
            isSelecting = false; 
            map.dragging.disable();
            map.getContainer().style.cursor = 'crosshair';
            drawPoints = [];
            if (drawLine) map.removeLayer(drawLine);
            drawLine = L.polyline([], {color: 'red', weight: 4, dashArray: '5, 10'}).addTo(map);
            map.on('click', addDrawPoint);
            document.getElementById('finishDrawBtn').style.display = 'inline-block';
        }

        function addDrawPoint(e) {
            drawPoints.push([e.latlng.lat, e.latlng.lng]);
            drawLine.setLatLngs(drawPoints);
        }

        async function finishDrawing(force = false) {
            if (!force) {
                map.off('click', addDrawPoint);
                map.dragging.enable();
                map.getContainer().style.cursor = '';
                document.getElementById('finishDrawBtn').style.display = 'none';
            }
            if (drawPoints.length < 2) {
                alert("Bitte mindestens 2 Punkte setzen!");
                if(drawLine) map.removeLayer(drawLine);
                return;
            }
            let name, households;
            if (!force) {
                name = prompt("Name der Stra√üe:");
                if (!name) return;
                let defaultCount = "10";
                try {
                    const countRes = await fetch('/admin/count_houses', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({path: drawPoints})
                    });
                    const countData = await countRes.json();
                    if(countData.count) defaultCount = countData.count.toString();
                } catch(e) { console.error(e); }

                households = prompt("Anzahl Haushalte:", defaultCount);
                if (!households) return;
            }
            let length = 0;
            for(let i=0; i<drawPoints.length-1; i++) length += map.distance(drawPoints[i], drawPoints[i+1]);
            const center = drawPoints[Math.floor(drawPoints.length/2)];
            const payload = {
                name: name || window.lastDrawName, 
                households: parseInt(households || window.lastDrawHouseholds),
                length: Math.round(length),
                coords: center,
                path: drawPoints,
                force: force
            };
            if(!force) { window.lastDrawName = name; window.lastDrawHouseholds = parseInt(households); }

            const res = await fetch('/admin/add_street', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) { alert("Gespeichert!"); location.reload(); }
            else if (data.error === 'duplicate') { if (confirm(`${data.msg}\nTrotzdem anlegen?`)) finishDrawing(true); }
            else alert("Fehler!");
        }

        async function downloadExport() { window.open('/admin/export_geojson', '_blank'); }

        async function editStreet(id) {
            const s = streets[id];
            const newName = prompt("Name √§ndern:", s.name);
            if (newName === null) return;
            const newHouseholds = prompt("Haushalte √§ndern:", s.households);
            if (newHouseholds === null) return;
            const res = await fetch('/admin/edit_street', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, name: newName, households: newHouseholds})
            });
            if((await res.json()).success) location.reload();
        }

        async function deleteStreet(id) {
            if(confirm(`'${streets[id].name}' l√∂schen?`)) {
                const res = await fetch('/admin/delete_street', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                if((await res.json()).success) location.reload();
            }
        }

        // Global functions must be available for buttons
        window.publishLive = async function(uuid) {
            if(confirm("Bist du sicher? \nDer aktuelle Live-Plan wird √ºberschrieben und dieser Plan wird aktiv.")) {
                const res = await fetch('/admin/publish', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({uuid: uuid})
                });
                const d = await res.json();
                if(d.success) {
                    alert("‚úÖ Erfolgreich ver√∂ffentlicht! Weiterleitung zum Live-Plan...");
                    window.location.href = "/";
                } else {
                    alert("Fehler: " + d.msg);
                }
            }
        }

        init();
    </script>
</body>
</html>