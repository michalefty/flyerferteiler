<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flyer-Planer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 0; background: var(--bg); color: #1e293b;
        }

        .header {
            position: sticky; top: 0; background: white; padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }

        .header h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--primary); }

        .user-box { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        
        select, input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }

        select { background-color: #fff; border-left: 5px solid var(--primary); }

        .progress-container { margin-top: 10px; background: #f1f5f9; padding: 10px; border-radius: 8px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; }
        .progress-bar { width: 100%; background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.8s ease; }

        .list-container { padding: 15px; padding-bottom: 100px; }
        .street-card {
            background: white; padding: 16px; margin-bottom: 12px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
        }
        
        .street-info strong { display: block; font-size: 1rem; margin-bottom: 4px; color: #334155; }
        .street-info span { font-size: 0.85rem; color: var(--secondary); }

        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: transform 0.1s; font-size: 0.9rem;
        }
        .btn-claim { background: var(--primary); color: white; }
        .btn-unselect { background: #e2e8f0; color: #475569; }
        .btn-export { background: var(--secondary); color: white; width: 100%; }
        
        .taken { border-left: 4px solid var(--danger); background: #fff1f2; opacity: 0.9; }
        .mine { border-left: 4px solid var(--success); background: #f0fdf4; }
        .taken-label { font-size: 0.8rem; font-weight: bold; color: var(--danger); text-align: right; display: block; }

        .footer-actions {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            padding: 15px; border-top: 1px solid #e2e8f0; z-index: 100;
        }

        .empty-state { text-align: center; color: var(--secondary); margin-top: 40px; }
    </style>
</head>
<body>

<div class="header">
    <h2>üìç Flyer-Verteilung</h2>
    <div class="user-box">
        <input type="text" id="username" placeholder="Dein Vorname..." onchange="saveName()">
        <select id="town-select" onchange="renderStreets()">
            <option value="">-- Ort/Ortsteil w√§hlen --</option>
        </select>
    </div>
    <div class="progress-container" id="progress-box" style="display:none;">
        <div class="progress-label">
            <span>Fortschritt im Bereich</span>
            <span id="progress-text">0%</span>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>
</div>

<div class="list-container" id="street-list">
    <div class="empty-state">Bitte w√§hle zuerst einen Ort aus.</div>
</div>

<div class="footer-actions">
    <button class="btn btn-export" onclick="exportMyStreets()">Meine Liste (.txt)</button>
</div>

<script>
    const socket = io();
    let currentData = {}; 
    
    window.onload = () => {
        const savedName = localStorage.getItem('flyer_username');
        if(savedName) document.getElementById('username').value = savedName;
    };

    function saveName() {
        const name = document.getElementById('username').value.trim();
        localStorage.setItem('flyer_username', name);
        renderStreets(); // UI aktualisieren, um "Freigeben"-Buttons zu zeigen/verstecken
    }

    socket.on('update_ui', (data) => {
        currentData = data.streets;
        updateDropdown();
        renderStreets();
    });

    function updateDropdown() {
        const select = document.getElementById('town-select');
        const previousValue = select.value;
        select.innerHTML = '<option value="">-- Ort/Ortsteil w√§hlen --</option>';
        
        Object.keys(currentData).sort().forEach(townKey => {
            const option = document.createElement('option');
            option.value = townKey;
            option.innerText = townKey.replace('_', ' ');
            select.appendChild(option);
        });

        if (previousValue && currentData[previousValue]) {
            select.value = previousValue;
        }
    }

    function renderStreets() {
        const selectedTown = document.getElementById('town-select').value;
        const list = document.getElementById('street-list');
        const progressBox = document.getElementById('progress-box');
        const currentUser = document.getElementById('username').value.trim();
        
        if (!selectedTown) {
            list.innerHTML = '<div class="empty-state">Bitte w√§hle zuerst einen Ort aus.</div>';
            progressBox.style.display = 'none';
            return;
        }

        progressBox.style.display = 'block';
        list.innerHTML = "";
        
        const streets = currentData[selectedTown];
        let totalH = 0, takenH = 0;

        const sortedKeys = Object.keys(streets).sort((a, b) => 
            streets[a].name.localeCompare(streets[b].name)
        );

        sortedKeys.forEach(id => {
            const street = streets[id];
            totalH += street.households;
            if(street.status === 'taken') takenH += street.households;

            const isTaken = street.status === 'taken';
            const isMine = isTaken && street.user === currentUser && currentUser !== "";
            
            const div = document.createElement('div');
            div.className = `street-card ${isMine ? 'mine' : (isTaken ? 'taken' : '')}`;
            
            div.innerHTML = `
                <div class="street-info">
                    <strong>${street.name}</strong>
                    <span>ca. ${street.households} Haushalte</span>
                </div>
                <div>
                    ${!isTaken 
                        ? `<button class="btn btn-claim" onclick="claim('${selectedTown}', '${id}')">Nehmen</button>` 
                        : (isMine 
                            ? `<button class="btn btn-unselect" onclick="unclaim('${selectedTown}', '${id}')">Freigeben</button>`
                            : `<span class="taken-label">‚úî ${street.user}</span>`
                          )
                    }
                </div>
            `;
            list.appendChild(div);
        });
        
        const percent = Math.round((takenH/totalH) * 100) || 0;
        document.getElementById('progress-fill').style.width = percent + "%";
        document.getElementById('progress-text').innerText = percent + "%";
    }

    function claim(townKey, streetId) {
        const user = document.getElementById('username').value.trim();
        if(!user) {
            alert("Bitte gib erst deinen Namen ein.");
            document.getElementById('username').focus();
            return;
        }
        socket.emit('select_street', {
            town_key: townKey,
            street_id: streetId, 
            user_name: user
        });
    }

    function unclaim(townKey, streetId) {
        const user = document.getElementById('username').value.trim();
        if(!confirm("M√∂chtest du diese Stra√üe wieder f√ºr andere freigeben?")) return;
        
        socket.emit('unselect_street', {
            town_key: townKey,
            street_id: streetId,
            user_name: user
        });
    }

    function exportMyStreets() {
        const user = document.getElementById('username').value.trim();
        if(!user) return alert("Bitte Name eingeben!");
        
        let text = `MEINE FLYER-LISTE: ${user}\nStand: ${new Date().toLocaleString()}\n`;
        text += `====================================\n\n`;
        
        let found = false;
        for (let townKey in currentData) {
            let townText = "";
            for (let sId in currentData[townKey]) {
                if (currentData[townKey][sId].user === user) {
                    townText += `[ ] ${currentData[townKey][sId].name} (${currentData[townKey][sId].households} Haushalte)\n`;
                    found = true;
                }
            }
            if (townText) text += `ORT: ${townKey.replace('_', ' ')}\n${townText}\n`;
        }

        if(!found) return alert("Du hast noch keine Stra√üen ausgew√§hlt.");
        
        const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Flyer_Checkliste_${user}.txt`;
        link.click();
    }
</script>
</body>
</html>